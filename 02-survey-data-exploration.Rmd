---
title: 'Hackathon Project Part 2: Survey Data Exploration'
subtitle: "Introduction to Data Science 2023 -- Hertie School -- Prof. Simon Munzert"
author: "Group Members: Lukas Lehmann (...) + Henry Baker (228755) + Jannes Neuse (...) + Lea Mathies (lmathies)"
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output: 
    html_document:
      TOC: FALSE
      number_sections: FALSE
      df_print: paged
      code_folding: show
      highlight: tango
      theme: cosmo
---

<style>
div.answer {background-color:#f0fcff; border-radius: 5px; padding: 20px;}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)
```

```{r, include=FALSE}
source("1-setup.R")
```

***

## Basic demographic distributions

### Overall Disribution

```{r}

party_distribution <- survey_usa_df |>
  group_by(personid, party_cat) |>
  summarise(count = n(), .groups = 'drop')

party_distribution_plot <- ggplot(party_distribution, aes(x = party_cat, y = count, fill = party_cat)) +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Party Categories by Respondent",
       x = "Party Category",
       y = "Number of Respondents") +
  scale_x_discrete(labels = function(x) tools::toTitleCase(x)) +
  theme_minimal()

party_distribution_plot

```

CAN THERE BE THIS MANY INDEPENDENTS?

NB this imbalance means we need to work with **proportions** of respondents of each party, rather than absolute counts.

### Republicans
```{r}

par(mfrow = c(3, 3))

# Gender
gender_plot <- ggplot(repub_subset, aes(x = factor(gender))) +
  geom_bar() +
  labs(title = "Gender Distribution among Republican Respondents", x = "Gender", y = "Count")

# Birth Year
birthyr_plot <- ggplot(repub_subset, aes(x = birthyr)) +
  geom_histogram(binwidth = 10) +
  labs(title = "Birth Year Distribution among Republican Respondents", x = "Birth Year", y = "Count")

# Race
race_plot <- ggplot(repub_subset, aes(x = factor(race))) +
  geom_bar() +
  labs(title = "Race Distribution among Republican Respondents", x = "Race", y = "Count")

# Education
educ_plot <- ggplot(repub_subset, aes(x = factor(educ))) +
  geom_bar() +
  labs(title = "Education Level Distribution among Republican Respondents", x = "Education Level", y = "Count")

# Family Income
faminc_plot <- ggplot(repub_subset, aes(x = factor(faminc_new))) +
  geom_bar() +
  labs(title = "Family Income Distribution among Republican Respondents", x = "Income Level", y = "Count")

# Religious Pew
regligpew_plot <- ggplot(repub_subset, aes(x = factor(religpew))) +
  geom_bar() +
  labs(title = "Religious Affiliation Distribution among Republican Respondents", x = "Religious Affiliation", y = "Count")

# Combine the plots in a 3x2 layout
n_label_plot_repub <- ggplot() +
  annotate("text", x = 0, y = 0, label = paste("Total n =", n_repub), size = 5) +
  theme_void()

combined_plot <- gender_plot / birthyr_plot / race_plot / educ_plot / faminc_plot / regligpew_plot / n_label_plot_repub + 
                 plot_layout(ncol = 2, nrow = 4)

combined_plot

```

For religious affiliation: 

- 1 = prot
- 2 = catholic
- 11 = nothing in particular

### Democrats

```{r basic democrat demographics}

par(mfrow = c(3, 2))

# Gender
gender_plot <- ggplot(demo_subset, aes(x = factor(gender))) +
  geom_bar() +
  labs(title = "Gender Distribution among Democratic Respondents", x = "Gender", y = "Count")

# Birth Year
birthyr_plot <- ggplot(demo_subset, aes(x = birthyr)) +
  geom_histogram(binwidth = 10) +
  labs(title = "Birth Year Distribution among Democratic Respondents", x = "Birth Year", y = "Count")

# Race
race_plot <- ggplot(demo_subset, aes(x = factor(race))) +
  geom_bar() +
  labs(title = "Race Distribution among Democratic Respondents", x = "Race", y = "Count")

# Education
educ_plot <- ggplot(demo_subset, aes(x = factor(educ))) +
  geom_bar() +
  labs(title = "Education Level Distribution among Democratic Respondents", x = "Education Level", y = "Count")

# Family Income
faminc_plot <- ggplot(demo_subset, aes(x = factor(faminc_new))) +
  geom_bar() +
  labs(title = "Family Income Distribution among Democratic Respondents", x = "Income Level", y = "Count")

# Religious Pew
regligpew_plot <- ggplot(demo_subset, aes(x = factor(religpew))) +
  geom_bar() +
  labs(title = "Religious Affiliation Distribution among Republican Respondents", x = "Religious Affiliation", y = "Count")

# Combine the plots in a 3x2 layout
n_label_plot_demo <- ggplot() +
  annotate("text", x = 0, y = 0, label = paste("Total n =", n_demo), size = 5) +
  theme_void()

combined_plot <- gender_plot / birthyr_plot / race_plot / educ_plot / faminc_plot / regligpew_plot / n_label_plot_demo + 
                 plot_layout(ncol = 2, nrow = 4)

combined_plot

```


## System trust by party

### As Count:

```{r system trust}

system_fair_count_plot <- ggplot(survey_usa_df,
       aes(x = system_fair, fill = party_cat)) +
  geom_bar(position = "dodge", binwidth = 1) +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  labs(title = "Distribution of System Fairness Perception by Party",
       x = "System Fairness Rating",
       y = "Count") +
  theme_minimal()

system_fair_count_plot
```

- 1 = strongly disagree
- 5 = strongly agree


interesting, of those that responded - a lot **more antisystem sentiment amongst democrats** (A self selection bias issue?)

Also high variance - definitely an interesting variable to unpack:

- what predictors for system_fair in survey data
- would be very interesting to see how tracking data maps on to this
- changes over time? recorded in all 7 waves: look how system trust changes for specific subsets within parties over time?
- does it change with changes in tracking data website visits and news consumption
- is it associated with non legacy media consumption? (age interaction term?) 
- diff in diff model: get baseline of similar units, then see how consumption of certain media in intervention group changes trust in system compared to control units?
- do late night users have less trust?

**BUT NB these counts are tiny - there are many NAs in the data:**

```{r}
tabyl(survey_usa_df$system_fair)
```
The valid percent is low... although some of the latter stats have even fewer valid observations: can we account for this somehow?


### As proportion:

NEED TO DO THIS FOR ALL PLOTS? (NUMBER OF REPUBLICANS VS DEMO VS INDEPENDENTS IS NOT BALANCED)


```{r}

# calc proportions
system_fair_prop_df <- survey_usa_df |>
  group_by(system_fair, party_cat) |>
  summarise(count = n(), .groups = 'drop') |>
  mutate(proportion = count / sum(count))

# plot
system_fair_proportion_plot <- ggplot(system_fair_prop_df, aes(x = system_fair, y = proportion, fill = party_cat)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("democrat" = "#1f77b4", "republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd", "not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(title = "Proportion of System Fairness Perception by Party",
       x = "System Fairness Rating",
       y = "Proportion",
       fill = "Party:") +
  theme_minimal()

system_fair_proportion_plot

```

This demonstrates how many NAs there are in the data - we are using answers from a tiny minority of respondents. Is this a problem we need to account for?

**To do: remove NAs across each outcome variables before plotting**

```{r}
# rescale it
system_fair_proportion_plot_rescale <- ggplot(system_fair_prop_df, aes(x = system_fair, y = proportion, fill = party_cat)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("democrat" = "#1f77b4", "republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd", "not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(title = "Proportion of System Fairness Perception by Party",
       x = "System Fairness Rating",
       y = "Proportion",
       fill = "Party:") +
  scale_y_continuous(limits = c(0, 0.02)) +
  theme_minimal()

system_fair_proportion_plot_rescale

```
The basic pattern is the same as when we did a count. 

## 'Trust variables'

*NB these are all count variables - for final analysis we need to make sure we are doing proportions of respondents given imbalance in number)

`media_trust_1`: How much trust and confidence do you have in the press when it comes to reporting the news about government and politics fully, accurately, and fairly?

```{r}

# media_trust_1
media_trust_1_plot <- ggplot(survey_usa_df, aes(x = media_trust_1, na.rm = T, fill = party_cat)) +
  geom_bar(position = "dodge", binwidth = 1) +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  labs(title = "Distribution of Trust in Media (1) by Party",
       x = "Media Trust",
       y = "Count") +
  theme_minimal()

media_trust_1_plot

```

- <1> A great deal
- <4> None at all

This distribution is much as expected

`media_trust_2`: How much trust and confidence do you have in the information you see on **Facebook** when it comes to reporting the fully, accurately, and fairly?

```{r}

# media_trust_2
media_trust_2_plot <- ggplot(survey_usa_df, aes(x = media_trust_2, na.rm = T, fill = party_cat)) +
  geom_bar(position = "dodge", binwidth = 1) +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  labs(title = "Distribution of Trust in Media (Facebook) by Party",
       x = "Media Trust (Facebook)",
       y = "Count") +
  theme_minimal()

media_trust_2_plot
```

- Democrats: standard normal distribution
- Republicans: leftwards skew (higher levels of distrust)
- Independents (and undecided / other) noticeably mirror republicans almost exactly, whereas democrats seem to be the outlier party...

*these are all counts; if we did proportion would the results look noticeably different?* Again, `n` is tiny for this variable:

```{r}
tabyl(survey_usa_df$media_trust_2)
```


```{r}
# media trust_bias

media_trust_bias_plot <- ggplot(survey_usa_df, aes(x = media_trust_bias, na.rm = T, fill = party_cat)) +
  geom_bar(position = "dodge", binwidth = 1) +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  labs(title = "Distribution of Trust in Media by Party",
       x = "Media Trust",
       y = "Count") +
  scale_x_discrete(labels = function(x) tools::toTitleCase(x)) +
  theme_minimal()

media_trust_bias_plot

```

- <1> Tend to favor the liberal side
- <5> Tend to favor the conservative side

- Democrats - again standard normal distribution, maybe slight skew towards agreeing that tend to favour liberal side
- Republicans - extreme thinking that favour liberal side
- Independents - bi-modal distribution saying favour liberals

## Platform statistics by party

```{r platform stats}

# function to create plot for a social media platform
platform_plot_fn <- function(data, platform, party_col = "party_cat") {
  ggplot(data, aes_string(x = party_col, fill = party_col)) +
    geom_bar(data = subset(data, get(platform) == 1)) +
    labs(title = paste("Users with", platform, "Accounts by Party"),
         x = "",
         y = "Count") +
    scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
    scale_x_discrete(labels = function(x) tools::toTitleCase(x)) +
    theme_minimal() + 
    theme(axis.text.x = element_blank())

}
  
# iterate
twitter_plot <- platform_plot_fn(survey_usa_df, "accounts_twitter")
facebook_plot <- platform_plot_fn(survey_usa_df, "accounts_facebook")
instagram_plot <- platform_plot_fn(survey_usa_df, "accounts_instagram")
linkedin_plot <- platform_plot_fn(survey_usa_df, "accounts_linkedin")

combined_plot <- twitter_plot / facebook_plot / instagram_plot / linkedin_plot +
                 plot_layout(ncol = 2)

combined_plot

```

Again, this is all counts. Things look different when you calculate proportions:

```{r proportional platform stats}

# function to calc props for each platform
calculate_proportions <- function(data, platform) {
  data |>
    group_by(party_cat) |>
    summarise(Proportion = mean(get(platform) == 1, na.rm = TRUE), .groups = 'drop')
}

# calc propsfor each platform
twitter_proportions <- calculate_proportions(survey_usa_df, "accounts_twitter")
facebook_proportions <- calculate_proportions(survey_usa_df, "accounts_facebook")
instagram_proportions <- calculate_proportions(survey_usa_df, "accounts_instagram")
linkedin_proportions <- calculate_proportions(survey_usa_df, "accounts_linkedin")

twitter_proportions
facebook_proportions
instagram_proportions
linkedin_proportions

# into one data frame
combined_proportions <- bind_rows(
  mutate(twitter_proportions, Platform = "Twitter"),
  mutate(facebook_proportions, Platform = "Facebook"),
  mutate(instagram_proportions, Platform = "Instagram"),
  mutate(linkedin_proportions, Platform = "LinkedIn")
)

# long format for plots
long_proportions <- pivot_longer(combined_proportions, 
                                 cols = -c(party_cat, Platform), 
                                 names_to = "SocialMedia", 
                                 values_to = "Proportion")

ggplot(long_proportions, aes(x = party_cat, y = Proportion, fill = party_cat)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(~ Platform) +
  labs(title = "Proportion of Each Party's Members Using Social Media Platforms",
       x = "Party",
       y = "Proportion") +
  scale_fill_manual(values = c("democrat" = "#1f77b4","republican" = "#d62728", "independent" = "#2ca02c", "other" = "#9467bd","not sure" = "#7f7f7f"),
                    labels = c("Democrat", "Republican", "Independent", "Other", "Not Sure")) +
  labs(fill = "Party:")  +
  scale_x_discrete(labels = function(x) tools::toTitleCase(x)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme_minimal()

```

## to do:

